/*! System - Game - v0.1.1 - 2014-02-20
* http://149.210.136.93/~ramus/shared/System/
* Copyright (c) 2014 ; Licensed  */
SYS=function(){this.version="0.1",this.canvas=document.getElementById("canvas"),this.context=this.canvas.getContext("2d"),this.WIDTH=this.canvas.width,this.HEIGHT=this.canvas.height,this.idCounter=0,this.id=this.idCounter++,this.spawnCounter=0,this.bounds=5e3},SYS.prototype={constructor:SYS,initialise:function(){this.drawables=[],this.physicsObjects=[],this.Math=new SYS.Math,this.delta,window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),new SYS.StationaryPhysicsBody(800,40,new SYS.Vector2(this.WIDTH/2,this.HEIGHT/2),new SYS.Vector2(0,0)),this.update()},update:function(){this.context.fillStyle="black",this.context.fillRect(0,0,this.WIDTH,this.HEIGHT);for(var a in this.physicsObjects)this.physicsObjects[a].simulate();this.spawnObjectsOnTimer();for(var a in this.drawables)this.drawables[a].draw();requestAnimFrame(function(){SYS.update()})},makeRandomObjects:function(){for(var a=0;80>a;a++){var b=new SYS.Vector2(Math.round(Math.random()*this.WIDTH),Math.round(Math.random()*this.HEIGHT)),c=new SYS.Vector2(8*Math.random()-4,8*Math.random()-4),d=4+6*Math.random(),e=Math.round(.5+.5*Math.random());new SYS.PhysicsBody(d,e,b,c)}},spawnObjectsOnTimer:function(){if(this.spawnCounter>480){for(var a=0;10>a;a++){var b=new SYS.Vector2(Math.round(Math.random()*this.WIDTH),Math.round(Math.random()*this.HEIGHT)),c=new SYS.Vector2(6*Math.random()-3,6*Math.random()-3),d=75+75*Math.random(),e=Math.round(3+1.5*Math.random());new SYS.PhysicsBody(d,e,b,c)}console.log("spawning"),this.spawnCounter=0}else this.spawnCounter++}},SYS.Math=function(){},SYS.Math.prototype={constructor:SYS.Math,getNormalBetweenVectors:function(a,b){var c=new SYS.Vector2(a.x,a.y),d=new SYS.Vector2(b.x,b.y);return d.sub(c),d.normalize(),d}},SYS.Vector2=function(a,b){this.x=a,this.y=b},SYS.Vector2.prototype={constructor:SYS.Vector2,add:function(a){this.x+=a.x,this.y+=a.y},sub:function(a){this.x-=a.x,this.y-=a.y},multiplyScalar:function(a){this.x*=a,this.y*=a},dot:function(){},normalize:function(){var a=this.magnitude();0!=a&&(this.x=this.x/a,this.y=this.y/a)},magnitude:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},distanceTo:function(a){var b=new SYS.Vector2(a.x,a.y),c=new SYS.Vector2(this.x,this.y);return b.sub(c),b.magnitude()},negate:function(){this.x*=-1,this.y*=-1}},SYS.PhysicsBody=function(a,b,c,d){this.mass=a,this.density=b,this.radius=a/b/(4*Math.PI),this.position=c,this.velocity=d,this.color="#603311",this.id=SYS.idCounter++,this.type=1,0!=this.mass&&SYS.physicsObjects.push(this),0!=this.radius&&SYS.drawables.push(this)},SYS.PhysicsBody.prototype={constuctor:SYS.PhysicsBody,draw:function(){SYS.context.beginPath(),SYS.context.arc(Math.round(this.position.x),Math.round(this.position.y),this.radius,0,2*Math.PI,!1),SYS.context.fillStyle=this.color,SYS.context.fill()},simulate:function(){this.position.magnitude()>SYS.bounds&&this.destroy;for(var a in SYS.physicsObjects)if(SYS.physicsObjects[a].position.distanceTo(this.position)<SYS.physicsObjects[a].mass&&this.id!=SYS.physicsObjects[a].id)if(this.position.distanceTo(SYS.physicsObjects[a].position)<this.radius+SYS.physicsObjects[a].radius){var b=new SYS.Vector2(this.velocity.x,this.velocity.y),c=new SYS.Vector2(SYS.physicsObjects[a].velocity.x,SYS.physicsObjects[a].velocity.y);if(b.negate(),c.add(b),c.magnitude()>10&&2!=SYS.physicsObjects[a].type)if(console.log("fragmenting!"),SYS.context.beginPath(),SYS.context.arc(Math.round(this.position.x),Math.round(this.position.y),4*this.radius,0,2*Math.PI,!1),SYS.context.fillStyle="#FF0000",SYS.context.fill(),this.mass>SYS.physicsObjects[a].mass){this.mass-=SYS.physicsObjects[a].mass;var d=new SYS.Vector2(SYS.physicsObjects[a].position.x,SYS.physicsObjects[a].position.y),e=new SYS.Vector2(SYS.physicsObjects[a].velocity.x,SYS.physicsObjects[a].velocity.y),f=new SYS.Vector2(this.velocity.x,this.velocity.y);f.normalize(),e.add(f);var g=new SYS.PhysicsBody(SYS.physicsObjects[a].mass,this.density,d,e),h=new SYS.Vector2(SYS.physicsObjects[a].velocity.x,SYS.physicsObjects[a].velocity.y);h.multiplyScalar(e.magnitude()/(2.5*this.radius)),g.position.add(h),SYS.physicsObjects[a].position.add(h)}else{SYS.physicsObjects[a].mass-=this.mass;var d=new SYS.Vector2(this.position.x,this.position.y),e=new SYS.Vector2(this.velocity.x,this.velocity.y),f=new SYS.Vector2(SYS.physicsObjects[a].velocity.x,SYS.physicsObjects[a].velocity.y);f.normalize(),e.add(f);var g=new SYS.PhysicsBody(this.mass,SYS.physicsObjects[a].density,d,e),h=new SYS.Vector2(this.velocity.x,this.velocity.y);h.multiplyScalar(e.magnitude()/(2.5*SYS.physicsObjects[a].radius)),g.position.add(h),this.position.add(h)}else if(2!=SYS.physicsObjects[a].type)if(this.mass>SYS.physicsObjects[a].mass){this.mass+=SYS.physicsObjects[a].mass,this.radius=this.mass/this.density/(4*Math.PI);var i=SYS.physicsObjects[a].mass/this.mass;SYS.physicsObjects[a].velocity.multiplyScalar(i),this.velocity.add(SYS.physicsObjects[a].velocity),SYS.physicsObjects[a].destroy()}else{SYS.physicsObjects[a].mass+=this.mass,SYS.physicsObjects[a].radius=SYS.physicsObjects[a].mass/SYS.physicsObjects[a].density/(4*Math.PI);var i=this.mass/SYS.physicsObjects[a].mass;this.velocity.multiplyScalar(i),SYS.physicsObjects[a].velocity.add(this.velocity),this.destroy()}}else{var j;j=SYS.Math.getNormalBetweenVectors(this.position,SYS.physicsObjects[a].position),0!=j.x&&0!=j.y&&j.multiplyScalar(SYS.physicsObjects[a].mass/SYS.physicsObjects[a].position.distanceTo(this.position)/100),this.velocity.add(j)}this.position.add(this.velocity)},destroy:function(){var a=SYS.drawables.indexOf(this);SYS.drawables.splice(a,1);var b=SYS.physicsObjects.indexOf(this);SYS.physicsObjects.splice(b,1)}},SYS.StationaryPhysicsBody=function(a,b,c,d){this.mass=a,this.density=b,this.radius=a/b/Math.PI,this.position=c,this.velocity=d,this.color="#FFD452",this.id=SYS.idCounter++,this.type=2,0!=this.mass&&SYS.physicsObjects.push(this),0!=this.radius&&SYS.drawables.push(this)},SYS.StationaryPhysicsBody.prototype={constuctor:SYS.StationaryPhysicsBody,draw:function(){SYS.context.beginPath(),SYS.context.arc(Math.round(this.position.x),Math.round(this.position.y),this.radius,0,2*Math.PI,!1),SYS.context.fillStyle=this.color,SYS.context.fill()},simulate:function(){for(var a in SYS.physicsObjects)SYS.physicsObjects[a].position.distanceTo(this.position)<SYS.physicsObjects[a].mass&&this.id!=SYS.physicsObjects[a].id&&this.position.distanceTo(SYS.physicsObjects[a].position)<this.radius+SYS.physicsObjects[a].radius&&this.mass>SYS.physicsObjects[a].mass&&(SYS.physicsObjects[a].velocity.multiplyScalar(SYS.physicsObjects[a].mass/400),this.velocity.add(SYS.physicsObjects[a].velocity),SYS.physicsObjects[a].destroy())},destroy:function(){var a=SYS.drawables.indexOf(this);SYS.drawables.splice(a,1);var b=SYS.physicsObjects.indexOf(this);SYS.physicsObjects.splice(b,1)}};